<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>íƒœì–‘ê³„ ì •ë³µ â€“ ì´ë²¤íŠ¸ì½”ì¸ ìƒì </title>

  <!-- PayApp Lite -->
  <script src="https://lite.payapp.kr/public/api/v2/payapp-lite.js"></script>

  <style>
    :root{
      --bg-gradient: radial-gradient(circle at top left,#1f2937,#020617 60%);
      --card-bg: rgba(15,23,42,0.88);
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.18);
      --border-soft: rgba(148,163,184,0.35);
      --danger: #f97373;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      margin:0;
      font-family:system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,sans-serif;
      background:var(--bg-gradient);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .shell{
      position:relative;
      width:100%;
      max-width:960px;
      border-radius:24px;
      background:linear-gradient(135deg,rgba(15,23,42,0.97),rgba(15,23,42,0.9));
      box-shadow:0 24px 70px rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.45);
      padding:20px;
      display:grid;
      gap:18px;
      overflow:hidden;
    }
    .shell::before{
      content:'';
      position:absolute;
      inset:0;
      border-radius:inherit;
      padding:1px;
      background:linear-gradient(135deg,rgba(56,189,248,0.7),rgba(129,140,248,0.5),rgba(45,212,191,0.7));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      opacity:0.65;
    }

    @media (min-width:768px){
      .shell{
        grid-template-columns:3fr 4fr;
        padding:24px 24px 22px;
      }
    }

    .hero{
      position:relative;
      padding:8px 4px 8px 2px;
      overflow:hidden;
    }
    .hero-title{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:22px;
      font-weight:800;
      letter-spacing:0.02em;
    }
    .hero-pill{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(34,197,94,0.16);
      border:1px solid rgba(34,197,94,0.7);
      color:#bbf7d0;
    }
    .hero-sub{
      margin-top:10px;
      font-size:13px;
      color:#9ca3af;
      line-height:1.5;
    }
    .hero-sub strong{
      color:#e5e7eb;
    }
    .hero-highlight{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,rgba(8,47,73,0.9),rgba(30,64,175,0.85));
      border:1px solid rgba(56,189,248,0.8);
      font-size:13px;
      box-shadow:0 12px 35px rgba(15,23,42,0.9);
    }
    .hero-highlight b{
      color:#e0f2fe;
    }
    .hero-badges{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
    }
    .badge{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background:rgba(15,23,42,0.82);
      color:#cbd5f5;
    }

    /* ì´ë¯¸ì§€ ì—†ì´ ìš°ì£¼ ë¶„ìœ„ê¸° ì—°ì¶œ */
    .hero-orbit{
      position:absolute;
      right:-40px;
      bottom:-40px;
      width:220px;
      height:220px;
      background:
        radial-gradient(circle at 30% 20%,rgba(56,189,248,0.6),transparent 60%),
        radial-gradient(circle at 80% 80%,rgba(249,115,22,0.55),transparent 55%);
      opacity:0.9;
      pointer-events:none;
    }
    .orbit-ring{
      position:absolute;
      inset:34px;
      border-radius:999px;
      border:1px dashed rgba(148,163,184,0.4);
      box-shadow:0 0 24px rgba(15,23,42,0.9) inset;
    }
    .planet{
      position:absolute;
      border-radius:999px;
    }
    .planet-main{
      width:46px;
      height:46px;
      right:60px;
      top:32px;
      background:radial-gradient(circle at 30% 20%,#facc15,#f97316);
      box-shadow:0 0 28px rgba(250,204,21,0.7);
    }
    .planet-sub{
      width:26px;
      height:26px;
      right:18px;
      bottom:52px;
      background:radial-gradient(circle at 30% 20%,#38bdf8,#6366f1);
      box-shadow:0 0 20px rgba(56,189,248,0.8);
    }

    .auth-card{
      background:var(--card-bg);
      border-radius:18px;
      border:1px solid var(--border-soft);
      padding:14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .auth-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .auth-title{
      font-size:15px;
      font-weight:600;
    }
    .auth-caption{
      font-size:11px;
      color:#9ca3af;
    }
    .auth-badge{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(56,189,248,0.12);
      border:1px solid rgba(56,189,248,0.7);
      color:#e0f2fe;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:6px;
    }
    .field label{
      font-size:11px;
      color:#9ca3af;
    }
    .field input{
      padding:8px 10px;
      border-radius:9px;
      border:1px solid rgba(75,85,99,0.9);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      font-size:13px;
    }
    .field input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(56,189,248,0.4);
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    button{
      border:none;
      cursor:pointer;
      font-size:12px;
      border-radius:999px;
      padding:7px 11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      color:white;
      border:1px solid rgba(191,219,254,0.9);
      box-shadow:0 8px 22px rgba(56,189,248,0.5);
    }
    .btn-primary:hover{
      filter:brightness(1.06);
    }
    .btn-secondary{
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.7);
    }

    .msg{
      margin-top:4px;
      font-size:11px;
      min-height:1.3em;
      color:#9ca3af;
    }
    .msg strong{color:#e5e7eb;}

    .login-note{
      margin-top:4px;
      font-size:11px;
      color:#fde68a;
      line-height:1.4;
    }

    .user-bar{
      margin-top:8px;
      padding:7px 10px;
      border-radius:12px;
      background:rgba(15,23,42,0.96);
      border:1px solid rgba(148,163,184,0.6);
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .user-email{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:200px;
    }

    .shop-card{
      margin-top:10px;
      background:var(--card-bg);
      border-radius:18px;
      border:1px solid var(--border-soft);
      padding:12px 12px 10px;
    }
    .shop-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .shop-title{
      font-size:14px;
      font-weight:600;
    }
    .shop-sub{
      font-size:11px;
      color:#9ca3af;
    }
    .shop-promo{
      font-size:11px;
      color:#fde68a;
    }

    .packs{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media (min-width:900px){
      .packs{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
    }
    .pack{
      position:relative;
      padding:9px 9px 9px;
      border-radius:14px;
      background:radial-gradient(circle at top,rgba(56,189,248,0.09),transparent 60%),
                 rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      flex-direction:column;
      gap:5px;
      font-size:11px;
    }
    .pack-name{
      font-weight:600;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:5px;
    }
    .pack-tag{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(34,197,94,0.16);
      border:1px solid rgba(34,197,94,0.6);
      color:#bbf7d0;
    }
    .pack-amount{
      color:#e5e7eb;
    }
    .pack-price{
      font-size:11px;
      color:#9ca3af;
    }
    .pack-highlight{
      font-size:10px;
      color:#a5b4fc;
    }
    .pack-icon{
      position:absolute;
      right:8px;
      top:7px;
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.7);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
    }
    .pack[data-tier="starter"] .pack-icon{border-color:#38bdf8;}
    .pack[data-tier="bag"] .pack-icon{border-color:#f97316;}
    .pack[data-tier="bigbag"] .pack-icon{border-color:#facc15;}
    .pack[data-tier="chest"] .pack-icon{border-color:#a855f7;}
    .pack[data-tier="vault"] .pack-icon{border-color:#22c55e;}

    .pack button{
      align-self:flex-start;
      margin-top:2px;
      padding:5px 9px;
      font-size:11px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.8);
    }
    .pack button:hover{
      border-color:var(--accent);
      color:#f9fafb;
    }

    /* í† ìŠ¤íŠ¸ */
    #toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%) translateY(8px);
      max-width:92%;
      padding:9px 12px;
      border-radius:999px;
      background:rgba(15,23,42,0.97);
      color:#e5e7eb;
      font-size:12px;
      border:1px solid rgba(148,163,184,0.75);
      box-shadow:0 10px 30px rgba(15,23,42,0.9);
      opacity:0;
      pointer-events:none;
      transition:opacity .22s ease-out,transform .22s ease-out;
      z-index:50;
    }
    #toast.show{
      opacity:1;
      pointer-events:auto;
      transform:translateX(-50%) translateY(0);
    }

  </style>
</head>
<body>
  <div class="shell">
    <!-- ì™¼ìª½: ì†Œê°œ -->
    <section class="hero">
      <div class="hero-title">
        <span>íƒœì–‘ê³„ ì •ë³µ Â· ì´ë²¤íŠ¸ì½”ì¸ ìƒì </span>
        <span class="hero-pill">x2 VALUE</span>
      </div>
      <p class="hero-sub">
        íƒœì–‘ê³„ ì •ë³µì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” <strong>ì´ë²¤íŠ¸ì½”ì¸</strong>ì„ ë¯¸ë¦¬ ì¶©ì „í•´ì„œ<br/>
        í•œì • ìƒì Â·ìš°ì£¼ì„ Â·ë°°ë„ˆ ì´ë²¤íŠ¸ë¥¼ ë” ë¹ ë¥´ê²Œ ì¦ê²¨ë´.
      </p>
      <div class="hero-highlight">
        <b>ğŸ ê²°ì œ ì¦‰ì‹œ ìš°í¸ ì§€ê¸‰</b><br/>
        ê°™ì€ ê³„ì •ìœ¼ë¡œ ê²°ì œí•˜ë©´ ê²Œì„ ìš°í¸í•¨ìœ¼ë¡œ ë°”ë¡œ ì§€ê¸‰ë¼.
      </div>
      <div class="hero-badges">
        <span class="badge">ì‹¤ì‹œê°„ ìš°í¸ ì§€ê¸‰</span>
        <span class="badge">PayApp ì•ˆì „ ê²°ì œ</span>
        <span class="badge">ê²Œì„ ê³„ì • ì—°ë™</span>
      </div>

      <!-- ì´ë¯¸ì§€ ëŒ€ì‹  CSS ì˜¤ë¸Œì íŠ¸ë¡œ ìš°ì£¼ ëŠë‚Œ -->
      <div class="hero-orbit">
        <div class="orbit-ring"></div>
        <div class="planet planet-main"></div>
        <div class="planet planet-sub"></div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ì¸ + ìƒì  -->
    <section>
      <div class="auth-card" id="auth-card">
        <div class="auth-header">
          <div>
            <div class="auth-title">ë¡œê·¸ì¸</div>
            <div class="auth-caption">
              <strong>íƒœì–‘ê³„ ì •ë³µ ê²Œì„ì—ì„œ ì“°ëŠ” ê³„ì •</strong>ìœ¼ë¡œë§Œ ë¡œê·¸ì¸í•´ ì¤˜.
            </div>
          </div>
          <div class="auth-badge">ê²Œì„ ê³„ì • í•„ìˆ˜</div>
        </div>

        <form id="login-form">
          <div class="field">
            <label for="email">ì´ë©”ì¼</label>
            <input id="email" type="email" autocomplete="email" placeholder="you@example.com" required/>
          </div>
          <div class="field">
            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
            <input id="password" type="password" autocomplete="current-password" required/>
          </div>
          <div class="btn-row">
            <button type="submit" class="btn-primary">
              ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸
            </button>
            <button type="button" id="google-btn" class="btn-secondary">
              Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
          </div>
        </form>

        <div class="login-note">
          âš  <strong>ë°˜ë“œì‹œ ê²Œì„ì—ì„œ ì“°ëŠ” ê³„ì •ê³¼ ê°™ì€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</strong>í•´ì•¼<br/>
          ì´ë²¤íŠ¸ì½”ì¸ì´ ì •í™•í•œ ê²Œì„ ìš°í¸í•¨ìœ¼ë¡œ ì§€ê¸‰ë¼.
        </div>

        <div class="msg" id="msg"></div>

        <div class="user-bar" id="user-box" style="display:none;">
          <div>
            <div style="font-size:10px;color:#9ca3af;">í˜„ì¬ ë¡œê·¸ì¸ëœ ê³„ì •</div>
            <div class="user-email" id="user-label"></div>
          </div>
          <button type="button" id="logout-btn" class="btn-secondary" style="font-size:11px;padding:5px 10px;">
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>

      <div class="shop-card" id="shop-card" style="margin-top:10px;opacity:0.35;pointer-events:none;">
        <div class="shop-header">
          <div>
            <div class="shop-title">ì´ë²¤íŠ¸ì½”ì¸ ìƒí’ˆ</div>
            <div class="shop-sub">ë¡œê·¸ì¸ í›„ êµ¬ë§¤ ê°€ëŠ¥ Â· ê²°ì œ í›„ ì¦‰ì‹œ ìš°í¸ ì§€ê¸‰</div>
          </div>
          <div class="shop-promo">ğŸ”¥ ì§€ê¸ˆì€ <strong>x2 VALUE</strong> í”„ë¡œëª¨ì…˜ ê¸°ê°„!</div>
        </div>

        <div class="packs" id="pay-section">
          <div class="pack" data-tier="starter">
            <div class="pack-icon">âœ¨</div>
            <div class="pack-name">
              ìŠ¤íƒ€í„° ë¬¶ìŒ
              <span class="pack-tag">ì…ë¬¸ìš©</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 120ê°œ</div>
            <div class="pack-price">â‚©1,100 Â· ì†Œì†Œí•˜ê²Œ ì‹œì‘í•˜ê¸°</div>
            <div class="pack-highlight">íŠœí† ë¦¬ì–¼Â·ì‘ì€ ë²„í”„ìš©ì— ì ë‹¹í•œ êµ¬ì„±.</div>
            <button onclick="startPay('eco-120')">120 EC êµ¬ë§¤</button>
          </div>

          <div class="pack" data-tier="bag">
            <div class="pack-icon">ğŸ’</div>
            <div class="pack-name">
              ì‘ì€ ìë£¨
              <span class="pack-tag">x2 VALUE</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 300ê°œ</div>
            <div class="pack-price">â‚©2,200 Â· ê°€ì„±ë¹„ íŒ¨í‚¤ì§€</div>
            <div class="pack-highlight">ì´ë²¤íŠ¸ ì „ìš© ìƒì ì—ì„œ ì²´ê° ê°€ì¹˜ ìƒìŠ¹.</div>
            <button onclick="startPay('eco-300')">300 EC êµ¬ë§¤</button>
          </div>

          <div class="pack" data-tier="bag">
            <div class="pack-icon">ğŸ§º</div>
            <div class="pack-name">
              ì¤‘í˜• ìë£¨
              <span class="pack-tag">ì¶”ì²œ</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 700ê°œ</div>
            <div class="pack-price">â‚©4,400 Â· í•œì • ìƒì  ëŒ€ë¹„ ìµœì </div>
            <div class="pack-highlight">ì´ë²¤íŠ¸ í•œ ë²ˆì€ ë„‰ë„‰í•˜ê²Œ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì–‘.</div>
            <button onclick="startPay('eco-700')">700 EC êµ¬ë§¤</button>
          </div>

          <div class="pack" data-tier="bigbag">
            <div class="pack-icon">ğŸ’°</div>
            <div class="pack-name">
              ëŒ€í˜• ìë£¨
              <span class="pack-tag">x2 VALUE</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 1,600ê°œ</div>
            <div class="pack-price">â‚©8,800 Â· ìì£¼ í•˜ëŠ” ìœ ì €ìš©</div>
            <div class="pack-highlight">ìš°ì£¼ì„ Â·ë°°ë„ˆ ì´ë²¤íŠ¸ë¥¼ ì—¬ìœ  ìˆê²Œ ëŒ€ë¹„.</div>
            <button onclick="startPay('eco-1600')">1,600 EC êµ¬ë§¤</button>
          </div>

          <div class="pack" data-tier="chest">
            <div class="pack-icon">ğŸ“¦</div>
            <div class="pack-name">
              ë³´ë¬¼ ìƒì
              <span class="pack-tag">ê³ ê¸‰</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 3,600ê°œ</div>
            <div class="pack-price">â‚©18,000 Â· í—¤ë¹„ ìœ ì € íŒ¨í‚¤ì§€</div>
            <div class="pack-highlight">2~3íšŒ ëŒ€í˜• ì´ë²¤íŠ¸ë¥¼ í•œ ë²ˆì— ì¤€ë¹„.</div>
            <button onclick="startPay('eco-3600')">3,600 EC êµ¬ë§¤</button>
          </div>

          <div class="pack" data-tier="vault">
            <div class="pack-icon">ğŸ¦</div>
            <div class="pack-name">
              ìš°ì£¼ ì°½ê³ 
              <span class="pack-tag">MAX VALUE</span>
            </div>
            <div class="pack-amount">ì´ë²¤íŠ¸ì½”ì¸ 8,000ê°œ</div>
            <div class="pack-price">â‚©39,000 Â· ì¥ê¸° íˆ¬ììš©</div>
            <div class="pack-highlight">ì¥ê¸°ì ì¸ í•œì • ì½˜í…ì¸  ëŒ€ë¹„, ìµœëŒ€ í˜œíƒ.</div>
            <button onclick="startPay('eco-8000')">8,000 EC êµ¬ë§¤</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast"></div>

  <!-- ====== Firebase + ë¡œì§ (type=module, body ëì— ìœ„ì¹˜) ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getDatabase, ref, get, onValue
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrsnUYEBG3cqbPrKD_eejOdtsCDjYG9k",
      authDomain: "siu-studio.firebaseapp.com",
      databaseURL: "https://siu-studio-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "siu-studio",
      storageBucket: "siu-studio.appspot.com",
      messagingSenderId: "830887143444",
      appId: "1:830887143444:web:70b45fc12140e893c31f01",
      measurementId: "G-1Y090YJDB6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const loginForm  = document.getElementById('login-form');
    const googleBtn  = document.getElementById('google-btn');
    const logoutBtn  = document.getElementById('logout-btn');
    const msgBox     = document.getElementById('msg');
    const userBox    = document.getElementById('user-box');
    const userLabel  = document.getElementById('user-label');
    const shopCard   = document.getElementById('shop-card');
    const toastBox   = document.getElementById('toast');

    function setMsg(text){
      if(!msgBox) return;
      msgBox.textContent = text || '';
    }
    function showToast(message, timeoutMs = 5000){
      if(!toastBox) return;
      toastBox.textContent = message;
      toastBox.classList.add('show');
      if(timeoutMs > 0){
        setTimeout(()=>toastBox.classList.remove('show'), timeoutMs);
      }
    }

    const PAYAPP_USERID = 'siustudio';

    // í”„ë¡ íŠ¸ì—ì„œ ì“°ëŠ” ìƒí’ˆ ìŠ¤í™ (ë°±ì—”ë“œ PACKSì™€ ë°˜ë“œì‹œ ë§ì¶”ê¸°!)
    const PACKS = {
      "eco-120":  { priceKRW: 1100,  ecoins: 120,  title: "ìŠ¤íƒ€í„° ë¬¶ìŒ" },
      "eco-300":  { priceKRW: 2200,  ecoins: 300,  title: "ì´ë²¤íŠ¸ì½”ì¸ ì‘ì€ ìë£¨" },
      "eco-700":  { priceKRW: 4400,  ecoins: 700,  title: "ì´ë²¤íŠ¸ì½”ì¸ ì¤‘í˜• ìë£¨" },
      "eco-1600": { priceKRW: 8800,  ecoins: 1600, title: "ì´ë²¤íŠ¸ì½”ì¸ ëŒ€í˜• ìë£¨" },
      "eco-3600": { priceKRW: 18000, ecoins: 3600, title: "ì´ë²¤íŠ¸ì½”ì¸ ë³´ë¬¼ ìƒì" },
      "eco-8000": { priceKRW: 39000, ecoins: 8000, title: "ì´ë²¤íŠ¸ì½”ì¸ ìš°ì£¼ ì°½ê³ " }
    };

    function enableShop(enabled){
      if(!shopCard) return;
      if(enabled){
        shopCard.style.opacity = '1';
        shopCard.style.pointerEvents = 'auto';
      }else{
        shopCard.style.opacity = '0.35';
        shopCard.style.pointerEvents = 'none';
      }
    }

    let mailboxListenerAttached = false;

    async function attachMailboxListener(user){
      if(!user || mailboxListenerAttached) return;
      mailboxListenerAttached = true;
      try{
        setMsg('ê²Œì„ ìš°í¸í•¨ ì—°ê²° ì¤‘...');
        const mapRef = ref(db,'userServerMap/'+user.uid);
        const mapSnap = await get(mapRef);
        if(!mapSnap.exists()){
          setMsg('ë¨¼ì € íƒœì–‘ê³„ ì •ë³µ ê²Œì„ì— ì ‘ì†í•´ì„œ ê³„ì •ì„ ë§Œë“¤ì–´ ì¤˜.');
          return;
        }
        const mapVal = mapSnap.val() || {};
        const server = mapVal.server;
        const id     = mapVal.id;
        if(!server || !id){
          setMsg('ê²Œì„ ê³„ì • ë§¤í•‘ ì •ë³´ì— ë¬¸ì œê°€ ìˆì–´.');
          return;
        }
        const mailboxRef = ref(db,`users/${server}/${id}/mailbox`);
        let prevIds = new Set();
        onValue(mailboxRef,(snap)=>{
          const raw = snap.exists() ? snap.val() : {};
          const entries = Object.entries(raw || {}).map(([id,mail])=>({id,...(mail||{})}));
          entries.sort((a,b)=>(b.sentAt||0)-(a.sentAt||0));
          const now = Date.now();
          const newOnes = entries.filter(m=>!prevIds.has(m.id));
          prevIds = new Set(entries.map(m=>m.id));
          if(!newOnes.length) return;

          const recent = newOnes.filter(m=>{
            const sent = Number(m.sentAt || 0);
            return sent && (now - sent < 10*60*1000);
          });
          if(!recent.length) return;

          const ecoMails = recent.filter(m=>{
            const r = m.rewards || {};
            const eco = Number(r.eventCoins ?? r.eco ?? r.ecoins ?? 0);
            return eco > 0;
          });

          if(ecoMails.length){
            const totalEco = ecoMails.reduce((sum,m)=>{
              const r = m.rewards || {};
              const eco = Number(r.eventCoins ?? r.eco ?? r.ecoins ?? 0) || 0;
              return sum + Math.max(0,Math.floor(eco));
            },0);
            if(totalEco > 0){
              showToast(`ğŸ ê²°ì œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! ì´ë²¤íŠ¸ì½”ì¸ ${totalEco}ê°œê°€ ê²Œì„ ìš°í¸í•¨ìœ¼ë¡œ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`,7000);
              setMsg('ê²°ì œê°€ ì™„ë£Œë˜ì–´ ê²Œì„ ìš°í¸í•¨ìœ¼ë¡œ ì´ë²¤íŠ¸ì½”ì¸ì´ ë°œì†¡ëì–´.');
              return;
            }
          }
          showToast('ìƒˆ ìš°í¸ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤. íƒœì–‘ê³„ ì •ë³µ ê²Œì„ì˜ ìš°í¸í•¨ì„ í™•ì¸í•´ ì¤˜.',6000);
        });
        setMsg('ë¡œê·¸ì¸ ì™„ë£Œ. ê²Œì„ ìš°í¸í•¨ê³¼ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){
        console.error(err);
        setMsg('ìš°í¸í•¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë¶€ëª¨ì°½ì— "ìƒì  í”„ë ˆì„ ì¤€ë¹„ ì™„ë£Œ" ì‹ í˜¸(í•„ìš” ì—†ìœ¼ë©´ ë¬´ì‹œí•´ë„ ë¨)
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ source:'siu-space', type:'ECO_SHOP_READY' }, '*');
    }

    onAuthStateChanged(auth,(user)=>{
      if(user){
        if(loginForm){
          loginForm.style.opacity = '0.45';
          loginForm.style.pointerEvents = 'none';
        }
        if(userBox){
          userBox.style.display = 'flex';
        }
        if(userLabel){
          userLabel.textContent = user.email || user.displayName || user.uid;
        }
        setMsg('ë¡œê·¸ì¸ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆ ë¡œê·¸ì¸ëœ ê³„ì •ìœ¼ë¡œ ê²°ì œê°€ ì§„í–‰ë¼. (ê²Œì„ ê³„ì •ê³¼ ê°™ì€ì§€ ê¼­ í™•ì¸í•´ ì¤˜.)');
        enableShop(true);
        attachMailboxListener(user);

        // ë¡œê·¸ì¸ ì‹œ ì•Œë¦¼
        showToast('âš  ê²Œì„ê³¼ ê°™ì€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ì•¼ ì •í™•í•˜ê²Œ ì§€ê¸‰ë©ë‹ˆë‹¤. ì§€ê¸ˆ ë¡œê·¸ì¸ëœ ê³„ì •ìœ¼ë¡œ ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.',7000);
      }else{
        if(loginForm){
          loginForm.style.opacity = '1';
          loginForm.style.pointerEvents = 'auto';
        }
        if(userBox){
          userBox.style.display = 'none';
        }
        if(userLabel){
          userLabel.textContent = '';
        }
        enableShop(false);
        setMsg('ì´ë²¤íŠ¸ì½”ì¸ êµ¬ë§¤ë¥¼ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ ì¤˜.');
      }
    });

    loginForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = (document.getElementById('email')?.value || '').trim();
      const pw    = (document.getElementById('password')?.value || '').trim();
      if(!email || !pw){
        setMsg('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì¤˜.');
        return;
      }
      try{
        setMsg('ë¡œê·¸ì¸ ì¤‘...');
        await signInWithEmailAndPassword(auth,email,pw);
        // ì„±ê³µí•˜ë©´ onAuthStateChangedì—ì„œ ì•Œë¦¼ + ë©”ì‹œì§€ ì²˜ë¦¬
      }catch(err){
        console.error(err);
        setMsg('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+(err.code || err.message));
      }
    });

    googleBtn?.addEventListener('click', async ()=>{
      try{
        setMsg('Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì¤‘...');
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth,provider);
        // ì„±ê³µ ì‹œ onAuthStateChangedì—ì„œ ì²˜ë¦¬
      }catch(err){
        console.error(err);
        setMsg('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: '+(err.code || err.message));
      }
    });

    logoutBtn?.addEventListener('click', async ()=>{
      try{
        await signOut(auth);
      }catch(err){
        console.error(err);
      }
    });

    window.startPay = function startPay(packId){
      const user = auth.currentUser;
      if(!user){
        alert('ë¨¼ì € ë¡œê·¸ì¸í•´ ì¤˜. (ê²Œì„ì—ì„œ ì“°ëŠ” ê³„ì •ê³¼ ê°™ì€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•´)');
        return;
      }
      const p = PACKS[packId];
      if(!p){
        alert('ì•Œ ìˆ˜ ì—†ëŠ” ìƒí’ˆì…ë‹ˆë‹¤.');
        return;
      }
      const redirect = new URL('/',location.origin);
      redirect.hash = '#pay-done';

      const meta = {
        v:1,
        uid:user.uid,
        packId,
        ecoins:p.ecoins,
        priceKRW:p.priceKRW,
        t:Date.now()
      };

      try{
        showToast('PayApp ê²°ì œì°½ì„ ì—¬ëŠ” ì¤‘...',4000);
        PayApp
          .setParam('userid',PAYAPP_USERID)
          .setParam('shopname','íƒœì–‘ê³„ ì •ë³µ ì´ë²¤íŠ¸ì½”ì¸ ìƒì ')
          .setParam('goodname',p.title)
          .setParam('price',String(p.priceKRW))
          .setParam('feedbackurl',location.origin+'/api/payapp/feedback')
          .setParam('redirecturl',redirect.toString())
          .setParam('buyerid',user.uid)
          .setParam('var1',JSON.stringify(meta))
          .payrequest();
      }catch(err){
        console.error(err);
        alert('ê²°ì œë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
  </script>
</body>
</html>
